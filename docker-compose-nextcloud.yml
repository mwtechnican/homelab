version: "3.9"
##################################################################
networks:
  proxynet:
    name: proxynet
    external: true
  nextcloudnet:
    name: nextcloudnet

##################################################################
secrets:
  #----------------------------------------------------#
  nextcloud_admin_password:
      file: ./secrets/nextcloud_admin_password
  nextcloud_admin_user:
    file: ./secrets/nextcloud_admin_user
  nextcloud_postgres_db:
    file: ./secrets/nextcloud_postgres_db
  nextcloud_postgres_password:
    file: ./secrets/nextcloud_postgres_password
  nextcloud_postgres_user:
    file: ./secrets/nextcloud_postgres_user
  #----------------------------------------------------#

##################################################################
services:
  nextcloud-app:
    image: nextcloud
    container_name: 'nextcloud-app'
    hostname: 'nextcloud-app'
    restart: 'unless-stopped'
    volumes:
      - ./containerdata/nextcloud-app:/var/www/html
      - /etc/localtime:/etc/localtime:ro
    environment:
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB_FILE=/run/secrets/nextcloud_postgres_db
      - POSTGRES_USER_FILE=/run/secrets/nextcloud_postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/nextcloud_postgres_password
      - NEXTCLOUD_ADMIN_PASSWORD_FILE=/run/secrets/nextcloud_admin_password
      - NEXTCLOUD_ADMIN_USER_FILE=/run/secrets/nextcloud_admin_user
      - TRUSTED_PROXIES=172.18.0.2/24
      - NEXTCLOUD_TRUSTED_DOMAINS=host nextcloud.${DOMAIN}
      - REDIS_HOST=nextcloud-redis
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    secrets:
      - nextcloud_admin_password
      - nextcloud_admin_user
      - nextcloud_postgres_db
      - nextcloud_postgres_password
      - nextcloud_postgres_user
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.nextcloud-app.loadbalancer.server.port=80"
      - "traefik.http.routers.nextcloud-app.rule=Host(\"nextcloud.${DOMAIN}\")"
      - "traefik.http.routers.nextcloud-app.entrypoints=websecure"
    networks:
      proxynet:
      nextcloudnet:
  nextcloud-db:
    image: postgres
    container_name: 'nextcloud-db'
    hostname: 'nextcloud-db'
    restart: 'unless-stopped'
    volumes:
      - ./containerdata/nextcloud-db:/var/lib/postgresql/data
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB_FILE=/run/secrets/nextcloud_postgres_db
      - POSTGRES_USER_FILE=/run/secrets/nextcloud_postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/nextcloud_postgres_password
    secrets:
      - nextcloud_postgres_db
      - nextcloud_postgres_password
      - nextcloud_postgres_user
    networks:
      nextcloudnet:
  nextcloud-redis:
    image: redis:latest
    container_name: nextcloud-redis
    hostname: nextcloud-redis
    restart: 'unless-stopped'
    volumes:
      - ./containerdata/nextcloud-redis:/var/lib/redis
    networks:
      nextcloudnet: